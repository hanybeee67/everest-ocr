# services/ocr_parser.py (í…ŒìŠ¤íŠ¸ìš© ìµœì¢… ë²„ì „)

import os
import io
import re
import json
# ì•„ë˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” importë§Œ í•˜ê³  ì‹¤ì œ OCR í•¨ìˆ˜ì—ì„œëŠ” ì‚¬ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
#from google.cloud import vision 
#from PIL import Image 
from datetime import datetime

# ============================================
# 1. OCR ì§€ì ëª… ì •ì˜ (íŒŒì‹± ë¡œì§ ì‚¬ìš©)
# ============================================
BRANCH_NAMES = {
    "ë™ëŒ€ë¬¸": ["ì—ë² ë ˆìŠ¤íŠ¸ ë™ëŒ€ë¬¸", "ì°½ì‹ ë™", "ë™ëŒ€ë¬¸ì "],
    "êµ¿ëª¨ë‹ì‹œí‹°": ["ì—ë² ë ˆìŠ¤íŠ¸ êµ¿ëª¨ë‹", "êµ¿ëª¨ë‹ì‹œí‹°ì "],
    "ì˜ë“±í¬": ["ì—ë² ë ˆìŠ¤íŠ¸ ì˜ë“±í¬", "ì˜ë“±í¬ì "],
    "ì–‘ì¬": ["ì—ë² ë ˆìŠ¤íŠ¸ ì–‘ì¬", "ì˜¤ë£¡ë¹Œë”©", "ì–‘ì¬ì "],
    "ìˆ˜ì› ì˜í†µ": ["ì—ë² ë ˆìŠ¤íŠ¸ ìˆ˜ì›", "ì²­ëª…ë‚¨ë¡œ", "ì˜í†µì "],
    "ë™íƒ„": ["ì—ë² ë ˆìŠ¤íŠ¸ ë™íƒ„", "ë¡¯ë°ë°±í™”ì  ë™íƒ„", "ë™íƒ„ì "],
    "ë£¸ë¹„ë‹ˆ": ["ë£¸ë¹„ë‹ˆ", "ë™ë¬˜ì—­", "ìë§¤ì‹ë‹¹"],
}

# ============================================
# 2. OCR í…ìŠ¤íŠ¸ ì¶”ì¶œ í•¨ìˆ˜ (â˜…í…ŒìŠ¤íŠ¸ìš© ê°€ìƒ í•¨ìˆ˜â˜…)
# ============================================

def detect_text_from_receipt(image_path):
    """
    Google Cloud Vision API ëŒ€ì‹ , í…ŒìŠ¤íŠ¸ìš© ê°€ìƒ í…ìŠ¤íŠ¸ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
    """
    
    # ğŸš¨ í…ŒìŠ¤íŠ¸ìš© ì˜ìˆ˜ì¦ ë°ì´í„° ğŸš¨
    # ì§€ì ëª…ì„ 'ì˜ë“±í¬'ë¡œ ì„¤ì •í•˜ì—¬, ë‹¤ë¥¸ ì§€ì  ë°©ë¬¸(ë™ëŒ€ë¬¸) í…ŒìŠ¤íŠ¸ê°€ ê°€ëŠ¥í•˜ë„ë¡ í•©ë‹ˆë‹¤.
    test_text = """
    ì—ë² ë ˆìŠ¤íŠ¸ ì˜ë“±í¬ì 
    ì£¼ì†Œ: ì„œìš¸ ì˜ë“±í¬êµ¬ ê²½ì¸ë¡œ
    ì „í™”: 02-800-4488
    2025/12/05 16:15:30
    ìƒí’ˆ í•©ê³„ : 24,500 ì›
    VAT 10%: 2,450 ì›
    ê²°ì œê¸ˆì•¡: 24,500 ì›
    ì¹´ë“œ ìŠ¹ì¸ë²ˆí˜¸: 555566667777
    ì¼ë ¨ë²ˆí˜¸: NO: 112233
    """
    
    # ì‹¤ì œ íŒŒì¼ì€ ì‚­ì œí•©ë‹ˆë‹¤. (ì—…ë¡œë“œëœ ì´ë¯¸ì§€ë¥¼ ì‚­ì œí•˜ì—¬ ë””ìŠ¤í¬ ê³µê°„ í™•ë³´)
    try:
        os.remove(image_path)
    except OSError:
        pass
        
    return test_text # ì´ í…ìŠ¤íŠ¸ë¥¼ OCR ê²°ê³¼ë¡œ ê°€ì •í•˜ê³  ë°˜í™˜


# ============================================
# 3. í…ìŠ¤íŠ¸ íŒŒì‹± í•¨ìˆ˜ (OCR ê²°ê³¼ ë¶„ì„)
# ============================================
def parse_receipt_text(ocr_text):
    """ OCRë¡œ ì¶”ì¶œëœ í…ìŠ¤íŠ¸ì—ì„œ ì˜ìˆ˜ì¦ ë²ˆí˜¸, ì§€ì , ê¸ˆì•¡ì„ ì¶”ì¶œí•©ë‹ˆë‹¤. """
    data = {
        "receipt_no": None,
        "branch_paid": "ë¯¸í™•ì¸ ì§€ì ",
        "amount": 0,
    }
    
    # í…ìŠ¤íŠ¸ ì •ê·œí™”: ëª¨ë“  ë„ì–´ì“°ê¸° ì œê±°, ì†Œë¬¸ìí™”, ì¤„ë°”ê¿ˆ ì œê±°
    clean_text = ocr_text.replace('\n', ' ').replace(' ', '').lower()
    
    
    # --- A. ì§€ì ëª… ì¶”ì¶œ ---
    for official_name, keywords in BRANCH_NAMES.items():
        for keyword in keywords:
            if keyword.lower().replace(' ', '') in clean_text:
                data["branch_paid"] = official_name
                break
        if data["branch_paid"] != "ë¯¸í™•ì¸ ì§€ì ":
            break
            
            
    # --- B. ê¸ˆì•¡ (Amount) ì¶”ì¶œ ---
    # íŒ¨í„´: (í•©ê³„|ê²°ì œê¸ˆì•¡|total|tot|ê¸ˆì•¡|vatí¬í•¨) ì£¼ë³€ì˜ ìˆ«ì (\d[\d,]+)ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
    amount_match = re.search(r'(í•©ê³„|ê²°ì œê¸ˆì•¡|total|tot|ê¸ˆì•¡)[:\s]*(\d[\d,]+)', clean_text)
    if amount_match:
        data["amount"] = int(amount_match.group(2).replace(',', ''))
        
    # ê¸ˆì•¡ì´ ì¶”ì¶œë˜ì§€ ì•Šì•˜ì„ ê²½ìš°, 4ìë¦¬ ì´ìƒ ìˆ«ì ì¤‘ ê°€ì¥ í° ê°’ì„ ê¸ˆì•¡ìœ¼ë¡œ ê°€ì •
    if data["amount"] == 0:
        all_numbers = re.findall(r'\d{4,}', clean_text) 
        if all_numbers:
            data["amount"] = max([int(n) for n in all_numbers if int(n) > 500])
            
            
    # --- C. ì˜ìˆ˜ì¦ ë²ˆí˜¸ (Receipt No) ì¶”ì¶œ ---
    # íŒ¨í„´: (ìŠ¹ì¸ë²ˆí˜¸|ì¼ë ¨ë²ˆí˜¸|no) ì£¼ë³€ì˜ 8~12ìë¦¬ì˜ ìˆ«ì (ì¹´ë“œ ìŠ¹ì¸ë²ˆí˜¸ íŒ¨í„´)
    receipt_no_match = re.search(r'(ìŠ¹ì¸ë²ˆí˜¸|ì¼ë ¨ë²ˆí˜¸|no)[:_]?[-\s]?(\d{8,12})', clean_text)
    if receipt_no_match:
        data["receipt_no"] = receipt_no_match.group(2).replace('-', '')
    else:
        # ì˜ìˆ˜ì¦ ë²ˆí˜¸ê°€ ì—†ìœ¼ë©´ OCR í…ìŠ¤íŠ¸ í•´ì‹œê°’ì„ ì‚¬ìš© (ì¤‘ë³µ ì²´í¬ ë³´ì¥ ì•ˆë¨)
        data["receipt_no"] = "PARSE_FAIL_" + str(abs(hash(clean_text)))[:10]
        
    return data